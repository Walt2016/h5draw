<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <title>几何图形自定义</title>
    <link rel="shortcut icon" type="image/x-icon" href="data:image/gif;base64,YQ==">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/console.css">
    <link rel="stylesheet" href="css/draw.min.css?v=3">
</head>

<body>
    <div class="container" id="container">
        <div class="screen" id="screen">
            <canvas id="myCanvas"></canvas>
        </div>
        <div id="configPanel" class="hide">
            <div class="tab" layout="col">
                <div class="tab-head" layout="row" layout-align="between center" template="_tab-head-item_tpl" data="tabs">
                </div>
                <div class="tab-body scroll" template="_tab-body-item_tpl" data="tabs">
                </div>
            </div>
        </div>
        <div class="btn-group row fixedbottom" template="_btn_tpl">
        </div>
    </div>
    <div class="overlay hide"></div>
    <div class="modal hide">
        <div class="header"></div>
        <div class="main"></div>
        <div class="footer">
            <div class="btn confirm">确认</div>
        </div>
    </div>
    <script type="text/template" id="_btn_tpl">
        <div class="btn row center w100" on="configHandler" id="configBtn">设置
            <div class="icon upArrow ml4"></div>
        </div>
        <div class="btn hide w100" on="stopHandler" id="stopBtn">停止</div>
        <div class="btn" on="startHandler" id="startBtn">画图</div>
    </script>
    <script type="text/template" id="_tab-head-item_tpl">
        <div class="tab-head-item {=active|tabActive}" target="{=key}" flex on="tabHandler">{=text}</div>
    </script>
    <script type="text/template" id="_tab-body-item_tpl">
        <div class="tab-body-item {=active|tabBodyActive}" name="{=key}">
            <div class="grid mt4">
                <div class="row head">
                    <div class="hd flex">{=key} {=switch|switch}
                    </div>
                </div>
            </div>
            <div class="switchBody {=switch}">
                <div class="grid mt4">
                    <div class="row">
                        <div class="hd">字段</div>
                        <div style="width: 50px">自动</div>
                        <div class="td flex">值</div>
                    </div>
                    {=items|tabItem}
                </div>
            </div>
        </div>
    </script>
    <script type="text/template" id="_tab-body-item-row_tpl">
        <div class="row">
            <div class="hd">{=text}</div>
            <div style="width: 50px">
                <input type="checkbox" name="{=key}" on="autoNext" {=auto|checkbox}/>
            </div>
            <div class="td flex" on="pickerHandler">
                {=$this|$type}
                <span class="value">{=value}</span>
            </div>
        </div>
    </script>
    <script src="js/tpler.js?v=4"></script>
    <script>
    // _.debug();
    // return ;
    var optJson = {
        "shape": {
            "text": "图形",
            "active": true,
            "shape": {
                "type": "picker",
                "values": [{
                        "key": "line",
                        "text": "线条"
                    },
                    {
                        "key": "triangle",
                        "text": "三角形"
                    },
                    {
                        "key": "square",
                        "text": "正方形"
                    },
                    {
                        "key": "rectangle",
                        "text": "矩形"
                    },
                    {
                        "key": "polygon",
                        "text": "多边形"
                    },
                    {
                        "key": "star",
                        "text": "星形"
                    },
                    {
                        "key": "circle",
                        "text": "圆形"
                    },
                    {
                        "key": "inpolygon",
                        "text": "内切多边形"
                    },
                    {
                        "key": "rose",
                        "text": "玫瑰花"
                    },
                    {
                        "key": "sunflower",
                        "text": "太阳花"
                    },

                    {
                        "key": "sierpinski",
                        "text": "谢尔宾斯基三角形"
                    },
                    {
                        "key": "carpet",
                        "text": "谢尔宾斯基地毯"
                    },
                    {
                        "key": "ray",
                        "text": "射线"
                    },
                    {
                        "key": "ellipse",
                        "text": "椭圆"
                    },
                    {
                        "key": "diamond",
                        "text": "菱形"
                    },
                    {
                        "key": "cross",
                        "text": "交叉线"
                    },
                    {
                        "key": "ring",
                        "text": "环形"
                    },
                    {
                        "key": "spiral",
                        "text": "螺线"
                    },
                    {
                        "key": "fibonacci",
                        "text": "斐波那契螺线"
                    },
                    {
                        "key": "axialMirror",
                        "text": "轴对称"
                    }, {
                        "key": "comb",
                        "text": "蜂巢"
                    },
                    {
                        "key": "pentagram",
                        "text": "五角星"
                    },
                    {
                        "key": "vertices",
                        "text": "顶点"
                    },
                    {
                        "key": "reuleaux",
                        "text": "勒洛三角形"
                    },
                    {
                        "key": "Kohn",
                        "text": "科赫曲线"
                    },
                    {
                        "key": "beads",
                        "text": "佛珠"
                    },
                    {
                        "key": "rayFractal",
                        "text": "射线分形"
                    },
                    {
                        "key": "pie",
                        "text": "一笔画饼"
                    },
                    {
                        "key": "sun",
                        "text": "太阳"
                    },
                    {
                        "key": "text",
                        "text": "文字"
                    },
                    {
                        "key": "windmill",
                        "text": "风车"
                    },
                    {
                        "key": "cornercurve",
                        "text": "转角曲线"
                    },
                    {
                        "key": "heart",
                        "text": "心形"
                    },

                ],

                "index": 4,
                "text": "图形"

            },
            "a": {
                "type": "slider",
                "min": 0,
                "max": 180,
                "step": 1,
                "value": 0,
                "text": "角度",
                "auto": true
            },

            "r": {
                "type": "slider",
                "min": 1,
                "max": 100,
                "step": 1,
                "value": 30,
                "text": "半径"
            },
            "num": {
                "type": "slider",
                "min": 1,
                "max": 100,
                "step": 1,
                "value": 3,
                "text": "顶点数",
                "auto": true
            },
            "rRatio": {
                "type": "slider",
                "min": 0.1,
                "max": 10,
                "step": 0.1,
                "value": 1,
                // "type": "piker",
                // "values": [0.5, 0.6, 0.7, 0.8, 0.9, 0.99, 1, 1.01, 1.1, 1.2, 1.3, [0.5, 2],
                //     [0.1, 5, 2]
                // ],
                // "type": "cycle",
                // "index": 6,
                "text": "半径变化率"
            },
            "rRatioType": {
                "type": "picker",
                "values": [{
                        "key": "cv",
                        "text": "匀速"
                    },
                    {
                        "key": "ac",
                        "text": "加速"
                    }
                ],
                "index": 0,
                "text": "变化率类型"
            },
            "turns": {
                "type": "slider",
                "min": 1,
                "max": 50,
                "step": 1,
                "value": 1,
                "text": "匝数"
            },
            "begin": {
                "value": true,
                "text": "新开画布"
            },
            "closed": {
                "value": true,
                "text": "图形闭合"
            },
            "showExcircle": {
                "value": false,
                "text": "显示外切圆"
            },
            "showIncircle": {
                "value": false,
                "text": "显示内切圆"
            },

            "showVertices": {
                "value": false,
                "text": "显示顶点"
            },
            "identifierVertices": {
                "value": false,
                "text": "顶点编号"
            },
            "showAngle": {
                "value": false,
                "text": "标注夹角"
            },
            "showRadius": {
                "value": false,
                "text": "显示半径"
            },
            "showCenter": {
                "value": false,
                "text": "显示圆心"
            },
            "showDiagonal": {
                "value": false,
                "text": "显示对角线"
            },
            "showMirror": {
                "value": false,
                "text": "顶点镜像"
            },
            "fractal": {
                "value": false,
                "text": "分形"
            },
            "fractalRatio": {
                "type": "slider",
                "min": 0.1,
                "max": 0.9,
                "step": 0.1,
                "value": 0.5,
                "text": "分形系数"
            },
            "minR": {
                "type": "slider",
                "min": 1,
                "max": 30,
                "step": 1,
                "value": 5,
                "text": "最小半径"
            },
            "fractalIn": {
                "value": false,
                "text": "分形放大"
            },
            "fractalMirror": {
                "value": false,
                "text": "顶点镜像分形"
            },
            "maxLevel": {
                "type": "slider",
                "min": 1,
                "max": 8,
                "step": 1,
                "value": 5,
                "text": "最大级数"
            },
            "lineWidth": {
                "type": "slider",
                "min": 0,
                "max": 20,
                "step": 0.5,
                "value": 1,
                "text": "线条宽度"
            },
            "lineJoin": {
                "type": "picker",
                "values": [{
                        "key": "miter",
                        "text": "尖角"
                    },
                    {
                        "key": "round",
                        "text": "圆角"
                    },
                    {
                        "key": "bevel",
                        "text": "斜角"
                    },
                ],
                "index": 0,
                "text": "转角样式"
            },
            "lineColor": {
                "type": "color_rgb",
                "length": 15,
                "text": "线条颜色"
            },

            "dashed": {
                "value": false,
                "text": "虚线"
            },
            "dashLength": {
                "type": "slider",
                "min": 1,
                "max": 20,
                "step": 1,
                "value": 5,
                "text": "虚线宽度"
            },
            "curve": {
                "value": false,
                "text": "曲线"
            },
            "semiarc": {
                "value": false,
                "text": "半圆弧"
            },
            "fill": {
                "value": false,
                "text": "填色"
            },
            "fillInterval": {
                "value": false,
                "text": "间隔填色"
            },

            "color": {
                "type": "color_rgba",
                "length": 15,
                "text": "颜色"
            },
            "shadowBlur": {
                "type": "slider",
                "min": 0,
                "max": 20,
                "step": 1,
                "value": 0,
                "text": "阴影大小"
            },
            "shadowColor": {
                "type": "color_rgb",
                "length": 15,
                "text": "阴影颜色"
            },

            "disappear": {
                "type": "slider",
                "min": 0,
                "max": 2000,
                "step": 100,
                "value": 0,
                "text": "粒子消散"
            },

            "animate": {
                "value": false,
                "text": "动画"
            },
            "animationInterval": {
                "type": "slider",
                "min": 0,
                "max": 2000,
                "step": 100,
                "value": 10,
                "text": "动画间隔"
            },
            "easing": {
                "type": "picker",
                "values": [{
                        "key": "linear",
                        "text": "匀速动画"
                    },
                    {
                        "key": "elastic",
                        "text": "弹性动画"
                    },
                    {
                        "key": "collision",
                        "text": "碰撞动画"
                    },
                    {
                        "key": "easeIn",
                        "text": "加速"
                    },
                    {
                        "key": "easeOut",
                        "text": "减速"
                    },
                    {
                        "key": "wave",
                        "text": "加速减速"
                    },
                    {
                        "key": "opposite",
                        "text": "晃荡"
                    },
                ],
                "index": 0,
                "text": "动画效果"
            },
            


        },
        "group": {
            "text": "组合",
            "switch": "off",
            "group": {
                "type": "picker",
                "values": [{
                        "key": "polygon",
                        "text": "多边形"
                    },
                    {
                        "key": "surround",
                        "text": "环绕"
                    },
                    {
                        "key": "concentric",
                        "text": "同心"
                    },
                    {
                        "key": "excircle",
                        "text": "外切圆"
                    },
                    {
                        "key": "repeat",
                        "text": "平铺"
                    },
                    {
                        "key": "ring",
                        "text": "环形"
                    },
                    {
                        "key": "fractal",
                        "text": "分形"
                    },
                    {
                        "key": "cone",
                        "text": "锥形"
                    },
                    {
                        "key": "pillar",
                        "text": "柱形"
                    },
                    {
                        "key": "sudoku",
                        "text": "九宫格"
                    },



                ],
                "index": 0,
                "text": "组合"
            },
            "a": {
                "type": "slider",
                "min": 0,
                "max": 180,
                "step": 1,
                "value": 0,
                "text": "角度",
                "auto": true
            },
            "r": {
                "type": "slider",
                "min": 0,
                "max": 300,
                "step": 1,
                "value": 60,
                "text": "环绕半径"
            },
            "num": {
                "type": "slider",
                "min": 1,
                "max": 100,
                "step": 1,
                "value": 3,
                "text": "顶点数",
                "auto": true
            },

            "rotation": {
                "value": true,
                "text": "自转"
            },
            "interval": {
                "type": "slider",
                "min": 0,
                "max": 180,
                "step": 1,
                "value": 60,
                "text": "图形间距"
            },
            "animate": {
                "value": true,
                "text": "动画"
            },
            "animationInterval": {
                "type": "slider",
                "min": 0,
                "max": 2000,
                "step": 100,
                "value": 10,
                "text": "动画间隔"
            },
            "easing": {
                "type": "picker",
                "values": [{
                        "key": "none",
                        "text": "无"
                    }, {
                        "key": "linear",
                        "text": "匀速动画"
                    },
                    {
                        "key": "elastic",
                        "text": "弹性动画"
                    },
                    {
                        "key": "collision",
                        "text": "碰撞动画"
                    },
                    {
                        "key": "easeIn",
                        "text": "加速"
                    },
                    {
                        "key": "easeOut",
                        "text": "减速"
                    },
                    {
                        "key": "wave",
                        "text": "加速减速"
                    },
                    {
                        "key": "opposite",
                        "text": "晃荡"
                    },
                ],
                "index": 0,
                "text": "动画效果"
            },
            "sequence": {
                "type": "picker",
                "values": [{
                        "key": "clockwise",
                        "text": "顺时针"
                    },
                    {
                        "key": "anticlockwise",
                        "text": "逆时针"
                    },
                    {
                        "key": "shuffle",
                        "text": "乱序"
                    }
                ],
                "index": 0,
                "text": "时序"
            },

            "showRadius": {
                "value": false,
                "text": "显示半径"
            },
            "showCenter": {
                "value": false,
                "text": "显示圆心"
            },
            "link": {
                "value": false,
                "text": "相互连线"
            },
            "neighborLink": {
                "value": false,
                "text": "相邻连线"
            },
            "vertexLink": {
                "value": false,
                "text": "顶点连线"
            },
            "conic": {
                "value": false,
                "text": "锥线"
            },
            "identifierCenter": {
                "value": false,
                "text": "圆心编号"
            },
            "dashed": {
                "value": false,
                "text": "虚线"
            },
            "lineWidth": {
                "type": "slider",
                "min": 0,
                "max": 20,
                "step": 0.5,
                "value": 1,
                "text": "线条宽度"
            },
            "colorful": {
                "type": "picker",
                "values": [{
                        "key": "circle",
                        "text": "色相环"
                    }, {
                        "key": "gradient",
                        "text": "渐变"
                    },
                    {
                        "key": "singleGradient",
                        "text": "单色渐变"
                    },
                    {
                        "key": "random",
                        "text": "随机"
                    },
                    {
                        "key": "solid",
                        "text": "单色"
                    }
                ],
                "index": 0,
                "text": "颜色"
            },
            "lineColor": {
                "type": "color_rgb",
                "length": 15,
                "text": "线条颜色"
            },
        },
        "motion": {
            "text": "运动",
            "switch": "off",
            "motion": {
                "type": "picker", //_multi
                "values": [{
                        "key": "move",
                        "text": "自由移动"
                    },
                    {
                        "key": "rotate",
                        "text": "旋转"
                    },
                    {
                        "key": "zoom",
                        "text": "缩放"
                    },
                    // {
                    //     "key": "rotate_zoom",
                    //     "text": "旋转+缩放"
                    // },
                    // {
                    //     "key": "move_zoom",
                    //     "text": "移动+缩放"
                    // },
                    // {
                    //     "key": "move_rotate",
                    //     "text": "移动+旋转"
                    // },
                    // {
                    //     "key": "move_rotate_zoom",
                    //     "text": "移动+旋转+缩放"
                    // },
                    {
                        "key": "gravitate",
                        "text": "跳一跳"
                    },
                    // {
                    //     "key": "rotate_gravitate",
                    //     "text": "旋转+跳一跳"
                    // },
                    {
                        "key": "curve",
                        "text": "曲线运动"
                    },
                    {
                        "key": "transform",
                        "text": "变形"
                    },
                    {
                        "key": "jiggle",
                        "text": "颤抖"
                    },
                    {
                        "key": "float",
                        "text": "漂浮"
                    },
                    {
                        "key": "circle",
                        "text": "绕圆"
                    },
                    {
                        "key": "ellipse",
                        "text": "椭圆"
                    },
                    {
                        "key": "spiral",
                        "text": "螺旋"
                    },
                    // {
                    //     "key": "rotate_spiral",
                    //     "text": "旋转+螺旋"
                    // },
                    {
                        "key": "light",
                        "text": "发光"
                    },
                    // {
                    //     "key": "light_rotate",
                    //     "text": "发光+旋转"
                    // },
                    {
                        "key": "sineMove",
                        "text": "正弦函数运动"
                    },
                ],
                "index": 0,
                "text": "运动形式"
            },
            "speed": {
                "type": "slider",
                "min": 0.1,
                "max": 20,
                "step": 0.1,
                "value": 1,
                "text": "速度"
            },
            "num": {
                "type": "slider",
                "min": 1,
                "max": 100,
                "step": 1,
                "value": 1,
                "text": "物体数量"
            },
            "r": {
                "type": "slider",
                "min": 0,
                "max": 300,
                "step": 1,
                "value": 60,
                "text": "环绕半径"
            },
            "link": {
                "value": false,
                "text": "连线"
            },
            "bounce": {
                "value": true,
                "text": "反弹"
            },
            "colorful": {
                "value": true,
                "text": "多彩"
            },
            "shadow": {
                "value": false,
                "text": "光影效果"
            },

            "click": {
                "value": false,
                "text": "点击重绘"
            },
            "follow": {
                "value": true,
                "text": "点击跟随"
            },
            "simulate": {
                "value": false,
                "text": "模拟点击"
            },
            "simulateInterval": {
                "type": "slider",
                "min": 100,
                "max": 2000,
                "step": 100,
                "value": 1,
                "text": "点击频率"
            },
        },
        "global": {
            "text": "全局",
            "compositeOperation": {
                "type": "picker",
                "values": [{
                        "key": "source-over",
                        "text": "覆盖"
                    }, {
                        "key": "lighter",
                        "text": "重叠变亮"
                    },
                    {
                        "key": "xor",
                        "text": "重叠透明"
                    },
                    {
                        "key": "source-in",
                        "text": "重叠部分"
                    },
                    {
                        "key": "source-out",
                        "text": "非重叠部分"
                    },
                    {
                        "key": "destination-over",
                        "text": "插入背景"
                    },
                    {
                        "key": "difference",
                        "text": "不同"
                    }
                ],
                "index": 0,
                "text": "图像合成"
            },
            "alpha": {
                "type": "slider",
                "min": 0.1,
                "max": 1,
                "step": 0.1,
                "value": 1,
                "text": "透明度"
            },
            "showBackground": {
                "value": false,
                "text": "显示背景"
            },
            "background": {
                "type": "color_rgb",
                "length": 15,
                "text": "背景颜色"
            },
            "backgroundSize": {
                "type": "picker",
                "values": [{
                        "key": "fullscreen",
                        "text": "全屏"
                    }, {
                        "key": "1:1",
                        "text": "1:1"
                    },
                    {
                        "key": "4:3",
                        "text": "4:3"
                    },
                    {
                        "key": "16:9",
                        "text": "16:9"
                    },
                    {
                        "key": "5:2",
                        "text": "5:2"
                    }
                ],
                "index": 0,
                "text": "背景尺寸"
            },
            "showGrid": {
                "value": false,
                "text": "网格背景"
            },
            "grid": {
                "type": "picker",
                "values": [{
                    "key": "normal",
                    "text": "普通"
                }, {
                    "key": "ecgGrid",
                    "text": "心电图网格"
                }],
                "index": 0,
                "text": "网格类型"

            },
            "movie": {
                "type": "picker",
                "values": [{
                        "key": "none",
                        "text": "无"
                    },
                    
                    {
                        "key": "firework",
                        "text": "烟花"
                    }, {
                        "key": "starrySky",
                        "text": "星空"
                    },
                    {
                        "key": "rain",
                        "text": "下雨"
                    },
                    {
                        "key": "vertexTransform",
                        "text": "随变"
                    },
                    {
                        "key": "vertexRotate",
                        "text": "转变"
                    },
                    // {
                    //     "key": "bomb",
                    //     "text": "爆炸图形"
                    // },
                    // {
                    //     "key": "spiral",
                    //     "text": "螺旋线"
                    // },
                    // {
                    //     "key": "spiralPolygon",
                    //     "text": "螺旋多边形"
                    // },
                    // {
                    //     "key": "sliderGroup",
                    //     "text": "组合"
                    // },
                    // {
                    //     "key": "sliderDiagonal",
                    //     "text": "对角线"
                    // },
                    {
                        "key": "slider",
                        "text": "进度条策略"
                    },
                ],
                "index": 0,
                "text": "小电影"
            }
        }
    };

    console.log(optJson)
    var c = _.createOptCycle(optJson);
    console.log(c)
    console.log(c.init())
    console.log(c.viewData())

    var updateSlider = function(item, value, max) {
        var ps = 100 * value / max << 0;
        var color = ["#059CFA", "#ccc"];
        item.css({ 'background': '-webkit-linear-gradient(0deg, ' + color[0] + ' ' + ps + '%, ' + color[1] + ' ' + ps + '%)' })
    }

    var draw = _.draw({
        canvasid: "myCanvas",
        fullscreen: true
    })

    tpler({
        el: "#container",
        data: c.viewData(),
        filters: {
            tabItem: function(val) {
                return _.parseTpl({
                    template: "_tab-body-item-row_tpl",
                    data: val,
                    filters: this.filters
                })
            },
            checkbox: function(val) {
                return val ? 'checked' : ""
            },
            tabActive: function(val) {
                return val ? 'active' : "";
            },
            tabBodyActive: function(val) {
                return val ? "" : "hide"
            },
            slider: function(val) {
                var range = document.createElement("input");
                range.attr("type", "range");
                range.className = val.type;

                ["min", "max", "step", "value"].forEach(function(t) {
                    range.attr(t, val[t]);
                });
                updateSlider(range, val.value, val.max)


                if (val.type == "slider") {
                    var slider = document.createElement("div");
                    slider.className = "slider"
                    slider.id = val.id;
                    slider.attr("placeholder", val.text);
                    var subBtn = document.createElement("div");
                    subBtn.className = "btn-sub";
                    subBtn.innerText = "-"
                    var addBtn = document.createElement("div");
                    addBtn.className = "btn-add"
                    addBtn.innerText = "+"
                    var output = document.createElement("div");
                    output.className = "output";
                    output.innerText = range.value

                    slider.appendChild(subBtn);
                    slider.appendChild(range);
                    slider.appendChild(addBtn);
                    slider.appendChild(output);

                    if (val.max) {
                        slider.addClass('hide')
                        var arrow = document.createElement("span");
                        arrow.className = "arrow"
                        return slider.outerHTML + arrow.outerHTML
                    }
                    return slider.outerHTML
                } else {
                    range.id = val.id;
                    return range.outerHTML;
                }
            },
            switch: function(val) {
                var range = {
                    min: 0,
                    max: 1,
                    step: 1
                }
                range.value = val == "on" ? 1 : 0;
                range.type = val == "none" ? "switch hide" : "switch";
                return this.filters.slider(range)
            },
            toggle: function(val) {
                var range = {
                    min: 0,
                    max: 1,
                    step: 1
                }
                range.value = val.value == "是" ? 1 : 0;
                range.type = val.type;
                range.id = val.id
                return this.filters.slider(range)
            },
            color_rgb: function(val) {
                return this.filters.picker(val)
            },
            color_rgba: function(val) {
                return this.filters.picker(val)
            },
            picker: function(val) {
                var sel = document.createElement("select");
                var option;
                sel.attr("placeholder", val.text);
                sel.id = val.id;
                sel.className = val.type; //"picker" picker_multi
                sel.style.display = "none"
                val.values && val.values.forEach && val.values.forEach(function(t, i) {
                    var selected = i == val.index ? true : false;
                    if (t.text) {
                        option = new Option(t.text, t.key, selected);
                    } else {
                        option = new Option(t, t, selected);
                    }
                    sel.options.add(option)
                });
                var arrow = document.createElement("span");
                arrow.className = "arrow"
                return sel.outerHTML + arrow.outerHTML;
            },
            picker_multi: function(val) {
                return this.filters.picker(val)
            }
        },
        methods: _.extend({
                pickerHandler: function(item, ev) {

                    var overlay = _.$(".overlay");
                    var modal = _.$(".modal");
                    var main = modal.$('.main');
                    var output = item.$(".value");

                    var select = item.$("select");
                    var slider = item.$("div.slider");
                    if (select.length == 0 && slider.length == 0) return;

                    var close = document.createElement('span');
                    close.className = "close"
                    close.innerHTML = '&times;';
                    modal.appendChild(close);

                    var closeModal = function() {
                        _.hide(overlay, modal);
                        if (slider.length > 0) item.appendChild(slider.hide())
                        main.innerHTML = '';
                        main.removeClass("slider", "select")
                    }

                    function showModal() {
                        _.show(overlay, modal);
                    }
                    var header = modal.$('.header');
                    var confirm = modal.$(".confirm");


                    //slider
                    if (slider.length > 0) {
                        header.innerHTML = slider.hasAttribute('placeholder') ? slider.getAttribute('placeholder') : 'Select to option';
                        _.show(slider)
                        main.appendChild(slider);
                        main.addClass("slider");

                        var range = slider.$("input[type='range']")
                        var id = slider.id;
                        var ids = id.split("_");

                        var update = function(value, max) {
                            var value = +range.value,
                                max = +range.max;
                            output.innerHTML = value;
                            slider.$(".output").innerHTML = value;
                            c.setVal(ids.concat(["value"]), +value);

                            var index = c.getVal(ids.concat(["values"])).indexOf(+value);
                            c.setVal(ids.concat(["index"]), index);
                            updateSlider(range, value, max)
                        }

                        toucher([{
                            el: range,
                            type: "input",
                            callback: function(item, ev) {
                                update();
                            }
                        }, {
                            el: slider.$(".btn-sub"),
                            callback: function(item, ev) {
                                range.value = Number(range.value) - Number(range.step);
                                update();
                            }
                        }, {
                            el: slider.$(".btn-add"),
                            callback: function(item, ev) {
                                range.value = Number(range.value) + Number(range.step);;
                                update();
                            }
                        }])
                        showModal();
                    }

                    //select
                    if (select.length > 0) {
                        header.innerHTML = select.hasAttribute('placeholder') ? select.getAttribute('placeholder') : 'Select to option';
                        var type = select.className;
                        var options = Array.prototype.slice.call(select);
                        var ul = document.createElement("ul");
                        main.appendChild(ul);
                        main.addClass("select");
                        options.forEach(function(option, key) {
                            var li = document.createElement('li');
                            li.addClass("option");
                            ul.appendChild(li);

                            var txt = document.createElement('span');
                            txt.className = "txt";
                            txt.innerHTML = option.innerHTML;
                            var checkbox = document.createElement('input');
                            checkbox.name = "checkbox";
                            checkbox.type = "checkbox";
                            checkbox.value = option.innerHTML;

                            //选中
                            if (option.hasAttribute('selected')) {
                                li.addClass('selected');
                                checkbox.checked = true;
                            }


                            li.appendChild(txt);
                            li.appendChild(checkbox);
                            if (["color_rgba", "color_rgb", "color"].indexOf(type) >= 0) {
                                li.style.backgroundColor = option.innerHTML;
                            }
                            toucher({
                                el: li,
                                callback: function() {
                                    if (["color_rgba", "color_rgb", "color"].indexOf(type) >= 0) {
                                        item.$(".value").innerHTML = txt.innerHTML + '<div class="colorblock" style="background-color:' + option.innerHTML + '"></div>';
                                    } else {
                                        item.$(".value").text(txt.innerHTML);
                                    }



                                    //单选
                                    if (type !== "picker_multi") {
                                        ul.$("li").removeClass('selected');
                                        ul.$("[type='checkbox']").forEach(function(t) {
                                            t.checked = false;
                                        })
                                    }
                                    this.addClass('selected');
                                    var checkbox = this.$("[type='checkbox']");
                                    checkbox.checked = !checkbox.checked;

                                    var id = select.id;
                                    var ids = id.split("_");

                                    //单选
                                    options.forEach(function(t, i) {
                                        t.removeAttr('selected')
                                        var type = _.getVal(c.data, ids.concat(["type"])); //cdata.type
                                        if (t == option) {
                                            if (type == "picker") {} else if (type == "slider") {
                                                c.setVal(ids.concat(["value"]), +txt.innerHTML)
                                            } else if (type == "toggle") {
                                                c.setVal(ids.concat(["value"]), txt.innerHTML === "是")
                                            }
                                            c.setVal(ids.concat(["index"]), i)
                                        }
                                    })
                                    option.setAttribute('selected', 'selected');
                                    // closeModal();
                                }
                            })
                        });
                        showModal();

                    }

                    ev.preventDefault();
                    ev.stopPropagation();

                    toucher([{
                        el: close, //overlay,
                        callback: function(item, ev) {
                            ev.preventDefault();
                            ev.stopPropagation();
                            closeModal();
                        }
                    }, {
                        el: confirm,
                        callback: function(item, ev) {

                            // var result = [];
                            // _.$("[type='checkbox']").forEach(function(t) {
                            //     if (t.checked) {
                            //         result[result.length] = t.value
                            //     }
                            // })
                            // output.text(result);

                            //c.setVal  todo


                            ev.preventDefault();
                            ev.stopPropagation();
                            closeModal();
                        }
                    }])
                },
                tabHandler: function(item, ev) {
                    var target = item.attr("target");
                    item.addClass("active").siblings().removeClass("active");

                    _.$(".tab-body-item").forEach(function(t) {
                        if (t.attr("name") == target) {
                            t.show();
                        } else {
                            t.hide()
                        }
                    })

                    for (var key in c.data) {
                        if (key == target) {
                            c.setVal([key, "active"], true)
                        } else {
                            c.setVal([key, "active"], false)
                        }
                    }
                },
                configHandler: function(item, ev) {
                    var configPanel = _.$("#configPanel");
                    configPanel.$(".scroll").css({ height: (_.screen.y - 85) + "px" })
                    var icon = item.$(".icon");
                    if (configPanel.hasClass("hide")) {
                        configPanel.removeClass("hide");
                        icon.removeClass("upArrow").addClass("downArrow");
                        var cfg = _.extend({}, this, { data: c.viewData(), el: "#configPanel" });
                        // console.log(cfg);
                        tpler(cfg);
                    } else {
                        configPanel.addClass("hide");
                        icon.removeClass("downArrow").addClass("upArrow")
                    }
                },
                stopHandler: function(item, ev) {
                    draw.stop();
                },
                startHandler: function(item, ev) {
                    _.hide("#configPanel");
                    var icon = _.$("#configBtn .icon");
                    icon.removeClass("downArrow").addClass("upArrow")
                    draw.clear();
                    var opt = c.init()
                    console.log(opt)
                    draw.setup(opt);
                }
            },
            c.methods),
        callback: function() {
            _.$(".tab").css({ height: (_.screen.y - 30) + "px" })
            _.$(".screen").appendChild(draw.canvas)


            toucher([{
                el: "input.toggle",
                type: "input",
                callback: function(item, ev) { //
                    item.parent().$(".value").innerHTML = this.value == 1 ? "是" : "否"

                    var id = item.id;
                    var ids = id.split("_");

                    c.setVal(ids.concat(["value"]), this.value == 1 ? "是" : "否");
                    c.setVal(ids.concat(["index"]), this.value == 1 ? 0 : 1);

                    updateSlider(item, this.value, this.max)

                }
            }, {
                el: "input.switch",
                type: "input",
                callback: function(item, ev) {
                    console.log(item)
                    var key = item.closest(".tab-body-item").attr("name");
                    var bd = item.closest(".tab-body-item").$(".switchBody")

                    if (item.value == "1") {
                        bd.removeClass("off").addClass("on");
                    } else {
                        bd.removeClass("on").addClass("off");
                    }
                    updateSlider(item, this.value, this.max)

                    c.setVal([key, "switch"], this.value == "1" ? "on" : "off")
                }
            }])
        }
    })
    </script>
</body>

</html>